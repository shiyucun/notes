
# linux内核系统调用

- [linux内核系统调用](#linux内核系统调用)
  - [系统调用](#系统调用)
  - [系统调用号](#系统调用号)
  - [系统调用表](#系统调用表)
  - [实现原理](#实现原理)

## 系统调用

系统调用本质上是依据软中断实现用户态切换到内核态，其实就是CPU工作模式的切换(USR切换到SVC)。

C库函数访问硬件资源也必须调用系统调用函数，向内核发起访问硬件的请求，由内核实现硬件的操作。

当然也可以直接利用系统调用操作硬件。

## 系统调用号

linux系统每个系统调用都有对应的系统调用号，定义在内核源码 **arch/arm/include/asm/unistd.h**。

```c
...
#define __NR_write        4
#define __NR_open         5
....
```

## 系统调用表

linux内核利用系统调用表(数组)保存每一个系统调用函数对应的内核函数，其中存储函数的地址。

使用系统调用时以系统调用号为下标，在系统调用表中找到对应的内核函数。

内核源码 **arch/arm/kernel/calls.S** 中定义了系统调用表。

## 实现原理

1. 当应用程序调用系统调用函数时，首先调用到C库的函数
2. C库中的函数会做如下工作：
    - 保存系统调用函数对应的系统调用号到R7寄存器中
    - 调用svc指令触发软中断异常
3. CPU毫无条件的跳转到内核异常向量表的软中断处理入口，进程由用户态切换到内核态
4. 进入到软中断的处理入口后会做如下工作：
    - 从R7寄存器中取出之前保存的系统调用号
    - 根据系统调用号在内核系统调用表（数组）中找到对应的内核函数
    - 找到该内核函数后，调用此函数执行
5. 执行完毕，原路返回到用户空间
