
# ARM工作模式和寄存器

- [ARM工作模式和寄存器](#arm工作模式和寄存器)
  - [数据存储类型](#数据存储类型)
  - [大小端模式](#大小端模式)
  - [工作模式](#工作模式)
  - [工作状态](#工作状态)
  - [ARM寄存器组织](#arm寄存器组织)
  - [异常与异常向量表](#异常与异常向量表)

## 数据存储类型

ARM 微处理器支持的数据类型：

- 整型
  - byte(8bit)
  - halfword(16bit)
  - word(32bit)
  - doubleworld(64bit)
  - quadword(128bit)
- 浮点型
  - 支持half-precision(16bit)
  - single-precision(32bit)
  - double-precision(64bit)
- 其它

## 大小端模式

将数据 0x12345678 存储于地址 0x100~0x103，有下表中两种存储方式：

| 地址  | 大端模式 | 小端模式 |
| ----- | -------- | -------- |
| 0x100 | 12       | 78       |
| 0x101 | 34       | 56       |
| 0x102 | 56       | 34       |
| 0x103 | 78       | 12       |

由上表可以看到：

- 大端模式：低字节存储于高地址
- 小端模式：低字节存储于低地址

一般情况下 ARM 芯片使用的是小端模式。

编程判断机器使用的大小端模式：

```c
union {
    int a;
    char buf[4];
} test;

test.a = 0x00000001;
if (test.buf[0] == 0x01) {
    // 小端
}
```

## 工作模式

- 管理模式：SVC模式，处理器复位后或执行软中断指令(SWI)后进入该模式
- 快速中断模式：FIQ模式，发生高优先级中断时进入该模式
- 中断模式：IRQ模式，发生低优先级中断时进入该模式
- 中止模式：Abort模式，用于处理非正常访问存储器
- 未定义模式：Undef模式，用于处理未定义的指令
- 系统模式：system模式，与用户模式共用寄存器的特权模式
- 用户模式：user模式，多数应用程序和系统任务运行在该模式

其中，前五种属于异常模式，前六种属于特权模式。

对于用户态编程，工作于user模式；对于内核态编程，工作于SVC模式。

## 工作状态

| 工作状态 | 指令          | PC                 |
| -------- | ------------- | ------------------ |
| ARM      | 执行ARM指令   | PC值字对齐(32位)   |
| Thumb    | 执行Thumb指令 | PC值半字对齐(16位) |

切换工作状态：

```text
# 使用指令进行切换
BX Rm        # 指令
Rm[0] = 1    # 进THUMB状态
Rm[0] = 0    # 进ARM状态

# 处理器自动切换
# 处理器进行异常处理(IRQ、FIQ、Undef、SWI和Abort)时
#     若在Thumb状态，则进入ARM状态
#     异常处理返回后进入Thumb状态
```

ARM 程序和 Thumb 程序可以相互调用，状态开销几乎为0。

## ARM寄存器组织

| 寄存器         | 位置              | 访问                                 |
| -------------- | ----------------- | ------------------------------------ |
| ARM寄存器      | 位于ARM core      | 没有地址，C编程是很难访问到该寄存器  |
| 特殊功能寄存器 | 位于IC设计的SOC中 | 寄存器有特定地址，可以使用该地址访问 |

ARM寄存器共37个(32bit)，其中有31个通用寄存器和6个状态寄存器。

```text
1. 通用寄存器
    r0、r1、r2、r3、r4、r5、r6、r7、r8、r9、r10、r11、r12、r13、r14、r15
        r13(sp，栈指针寄存器)
        r14(lr，保存函数调用时的返回位置)
        r15(sp，指向取指令的位置)
    以上16个通用寄存器中：
        系统模式与用户模式完全共用(共16个)
        其余五个模式有单独的r13和r14寄存器(共10个)
        FIQ模式又有单独的r8~r12寄存器(共5个)
2. 状态寄存器
    cpsr：状态寄存器，七种模式共用该寄存器(共1个)
        [4-0]   标识、改变CPU的工作模式
        [5]     T，标识当前CPU的工作状态
        [6]     F，FIQ屏蔽位
        [7]     I，IRQ屏蔽位
        [27~8]  保留位
        [31~28] N(negative)、Z(zero)、C(carry)、V(overflow)
    spsr：cpsr的备份寄存器，除用户模式和系统模式外，其余模式各有一个该寄存器(共5个)
          分别为：SPSR_svc、SPSR_abt、SPSR_und、SPSR_irq和SPSR_fig
```

## 异常与异常向量表

当发生某种异常时硬件自动跳转到对应的位置去执行，此过程中不需要软件的干预，该位置称为异常向量表。

```text
1. 产生异常时硬件会自动完成下列工作：
    备份CPSR到SPSR_<mode>
    修改CPSR
      (a) 切换为ARM状态(ARM处理器只能ARM状态下处理异常)
      (b) 切换到相应的异常模式，CPSR [4~0]
      (c) 可能会禁止中断
    存储返回地址到LR_<mode>
    设置PC为相应的异常入口地址
2. 异常完成后，返回时软件需要完成以下工作：
    从SPSR_<mode>恢复CPSR<br>
    从LR_<mode>恢复PC<br>
```
