
# 性能优化分析工具

- [性能优化分析工具](#性能优化分析工具)
  - [工具](#工具)
  - [使用](#使用)
    - [free](#free)
    - [/proc/meminfo](#procmeminfo)
    - [uptime](#uptime)
    - [top](#top)
    - [vmstat](#vmstat)
    - [mpstat](#mpstat)
    - [sar](#sar)
    - [/proc/stat](#procstat)
    - [ps](#ps)
    - [pidstat](#pidstat)
    - [htop](#htop)
    - [atop](#atop)
    - [/proc/softirqs](#procsoftirqs)
    - [/proc/interrupts](#procinterrupts)
    - [dstat](#dstat)
    - [/proc/cpuinfo](#proccpuinfo)
    - [lscpu](#lscpu)
    - [perf](#perf)
    - [execsnoop](#execsnoop)
    - [proc/pid/stat](#procpidstat)

## 工具

指标 | 工具 | 说明
---|---|---
内存 | `free`、`/proc/meminfo` | 内存使用情况统计
平均负载 | `uptime`、`top` | `uptime`最简单<br>`top`提供了更安全的指标
系统整体CPU使用率 | `vmstat`、`mpstat`、`top`<br>`sar`<br>`/proc/stat` | `top`、`vmstat`、`mpstat`只可以动态查看<br>`sar`可以记录历史数据<br>`/proc/stat`是其它性能工具的数据来源
进程CPU使用率 | `top`、`ps`<br>`pidstat`<br>`htop`、`atop` | `top`和`ps`可以按照CPU使用率进行排序<br>`pidstat`只显示实际使用了CPU的进程<br> `htop`、`atop`以不同颜色显示更直观
系统上下文切换 | `vmstat` | 提供上下文切换次数<br>提供运行状态和不可中断状态进程数量
进程上下文切换 | `pidstat` | 需要__-w__选项
软中断 | `top`<br>`/proc/softirqs`、`mpstat` | `top`提供软中断CPU使用率<br>`/proc/softirqs`、`mpstat`提供每个CPU上各种软中断的运行次数
硬中断 | `/proc/interrupts`、`vmstat` | `/proc/interrupts`提供每个CPU上各种中断的累积运行次数<br>`vmstat`提供中断的总次数
网络 | `dstat`、`sar`<br>`tcpdump` | `dstat`和`sar`提供网络接收和发送情况统计<br>`tcpdump`用于动态抓取正在进行的网络通讯
I/O | `dstat`、`sar` | `dstat`和`sar`提供了I/O的整体情况
CPU个数 | `/proc/cpuinfo`、`lscpu` | `lscpu`更直观
事件剖析 | `perf`<br>`execsnoop` | `perf`可以用于分析CPU缓存以及内核调用链<br>`execsnoop`用于监控短时进程

## 使用

### free

`free`命令用于获取当前内存使用情况。

```shell
free
#               total        used        free      shared  buff/cache   available
# Mem:       32590704     1636496    28133840       10040     2820368    30487544
# Swap:       2097148           0     2097148

free -h
#               total        used        free      shared  buff/cache   available
# Mem:           31Gi       1.6Gi        26Gi       9.0Mi       2.7Gi        29Gi
# Swap:         2.0Gi          0B       2.0Gi

free -h -s 2
#               total        used        free      shared  buff/cache   available
# Mem:           31Gi       1.6Gi        26Gi       9.0Mi       2.7Gi        29Gi
# Swap:         2.0Gi          0B       2.0Gi
# 
#               total        used        free      shared  buff/cache   available
# Mem:           31Gi       1.6Gi        26Gi       9.0Mi       2.7Gi        29Gi
# Swap:         2.0Gi          0B       2.0Gi
```

首先，对上述代码块中的内容做一些说明：

- 默认单位为字节，`-h`可以显示带有单位的可读数据，`-s`选项是每隔x秒显示一次统计数据
- `Mem`行：内存使用情况
- `Swap`行：交换空间使用情况
- `total`列：物理内存和交换空间总大小
- `used`列：已经被使用的物理内存和交换空间大小
- `free`列：未使用的物理内存和交换空间大小
- `shared`列：共享使用的物理内存大小
- `buff/cache`列：buff 和 cache 使用的物理内存大小
- `available`列：可以被应用程序使用的物理内存大小

`buff/cache`：

- buff 即 buffer，翻译为缓冲区
  - 磁盘有两个概念(扇区和块)
    - 扇区是设备的最小寻址单元
    - 块是操作系统中文件系统的最小寻址单元(也称之为文件块或者I/O块)
    - 每个块包含一个或者多个扇区，但大小不能超过一个内存页
    - 一个内存页可以容纳一个或者多个块
    - 当一个块被读入内存时，它需要存储在缓冲区中
    - 每个缓冲区与一个块对应，即缓冲区中的数据就是磁盘块在内存中的表示
- cache 指的是`page cache`，翻译为`页高速缓存`
  - cache 是内核实现的磁盘缓存
  - 主要用于减少磁盘I/O操作
  - cacha 会把磁盘中的数据缓存到物理内存中，把对磁盘的访问变为对物理内存的访问
  - 缓存中的页来自对普通文件、块设备文件和内存映射文件的读写

页高速缓存对普通文件的缓存可以这样理解：

1. 当内核要读一个文件时，会先检查这个文件的数据是否已经在页高速缓存中了
2. 如果在，就放弃访问磁盘，直接从内存中读取，这个行为称为缓存命中
3. 如果数据不在缓存中，就是缓存未命中，此时内核就要调度块I/O操作从磁盘去读取数据
4. 内核会将读取的数据放入页高速缓存中，这种缓存的目标是文件系统可以识别的文件

无论是缓冲区还是页高速缓存，它们的实现方式都是一样的。

缓冲区只不过是一种概念上比较特殊的页高速缓存。

buff/cache 只有块的概念没有文件的概念，它只是把磁盘上的块直接搬到了内存中。

那么为什么`free`命令不直接称为 cache 而非要写成 buff/cache？

因为缓冲区和页高速缓存在`linux-kernel-2.4`中才将它们统一实现。

在更早的内核中有两个独立的磁盘缓存：

1. 页高速缓存：缓存页面
2. 缓冲区高速缓存：缓存缓冲区

`free/available`：

free 是真正尚未被使用的物理内存数量，available 是从应用程序的角度看到的可用内存数量。

linux内核为了提升磁盘操作性能，会消耗一部分内存去缓存磁盘数据，即 buff/cache。

所以对于内核来说，buff/cache 都属于已经被使用的内存。

当应用程序需要内存时，如果没有足够的 free 内存可以用，内核就会从 buff/cache 中回收内存。

**所以从应用程序的角度来说，available = free + buffer + cache。**

但以上只是一个很理想的计算方式，**实际中的数据往往有较大误差**。

`交换空间`：

交换空间是磁盘上的一块区域，可以是一个分区，也可以是一个文件。

当系统物理内存吃紧时，linux 会将内存中不常访问的数据保存到交换分区，这样就有了更多物理内存。

当系统需要访问交换分区上存储的内容时，再将其上的数据加载到内存，这就是常说的换出和换入。

交换空间可以在一定程度上缓解内存不足的情况，但需要读写磁盘数据，所以性能不是很高。

现在的机器一般都不太缺内存，如果系统默认还是使用了交换空间是不是会拖累系统的性能？

理论上是的，但实际上可能性并不是很大。

内核提供了一个 swappiness 参数，用于配置内存中不常用数据移到交换分区的紧迫程度。

这个参数的取值范围是`0～100`：

- 0：尽可能不要将内存数据移到交换分区中，即只有在迫不得已的情况下才移动
- 100：只要有可能，尽量将内存中不常访问的数据移到交换分区中

在 ubuntu 系统中，swappiness 的默认值是 60。

如果我们觉着内存充足，可以在`/etc/sysctl.conf`文件中设置`swappiness`：

```text
vm.swappiness=10
```

### /proc/meminfo

其实 free 命令中的信息都来自于 /proc/meminfo 文件。

/proc/meminfo 文件包含了更多更原始的信息，只是看起来不太直观：

``` shell
cat /proc/meminfo
# MemTotal:       32590704 kB       # 所有可用内存
# MemFree:        25912904 kB       # 尚未使用的内存
# MemAvailable:   28839796 kB       # MemFree + 可回收内存
# Buffers:          179676 kB       # 块设备所占用的缓存页
# Cached:          2935984 kB       # 普通文件所占用的缓存页
# SwapCached:            0 kB       # 被交换出的匿名页会先复制到此处，然后再复制到交换空间
# Active:          4093656 kB
# Inactive:        1685464 kB
# Active(anon):    2653700 kB
# Inactive(anon):    14932 kB
# Active(file):    1439956 kB
# Inactive(file):  1670532 kB
# Unevictable:         780 kB
# Mlocked:               0 kB       # mlock 系统调用锁定的内存大小
# SwapTotal:       2097148 kB
# SwapFree:        2097148 kB
# Dirty:                 0 kB       # dirty pages = (Dirty + NFS_Unstable + Writeback)
# Writeback:             0 kB       # 正准备回写硬盘的缓存页
# AnonPages:       2664016 kB       # 匿名页总大小
# Mapped:           673068 kB       # 被用户进程关联的文件缓存页
# Shmem:             17748 kB       # 共享内存占用空间总大小(tmpfs类型的文件系统及/dev/下所有文件占用的空间也计入共享内存)
# KReclaimable:     285420 kB
# Slab:             625532 kB
# SReclaimable:     285420 kB
# SUnreclaim:       340112 kB
# KernelStack:       16400 kB       # 内核栈总大小，每一个用户线程都会分配一个内核栈
# PageTables:        32448 kB       # 用于将虚拟地址翻译成物理地址，内存分配越多该字段会越大
# NFS_Unstable:          0 kB       # 发给NFS server但尚未写入硬盘的缓存页
# Bounce:                0 kB       # 部分老设备只能访问低端内存，当 I/O 请求访问高端内存时，高端内存数据会复制到此处以供访问
# WritebackTmp:          0 kB
# CommitLimit:    18392500 kB
# Committed_AS:    8244368 kB
# VmallocTotal:   34359738367 kB    # 通过 vmalloc 等操作分配的内存(一些驱动、文件系统、网络模块或加载内核模块时会调用vmalloc)
# VmallocUsed:       74740 kB
# VmallocChunk:          0 kB
# Percpu:            18112 kB
# HardwareCorrupted:     0 kB       # 系统检测到内存硬件故障时会把有问题的页面删除，删除掉的内存页的总大小
# AnonHugePages:         0 kB       # 匿名巨页总大小
# ShmemHugePages:        0 kB       # 共享内存
# ShmemPmdMapped:        0 kB
# FileHugePages:         0 kB
# FilePmdMapped:         0 kB
# HugePages_Total:       0          # 巨页总空间
# HugePages_Free:        0          # 巨页空闲空间
# HugePages_Rsvd:        0          # 巨页已使用空间
# HugePages_Surp:        0          
# Hugepagesize:       2048 kB       # 巨页页面大小
# Hugetlb:               0 kB
# DirectMap4k:      732740 kB       # 反映 TLB 效率指标，TLB(Translation Lookaside Buffer)是位于CPU上的缓存
# DirectMap2M:    10508288 kB       # TLB 用于将内存的虚拟地址翻译成物理地址，大小有限，不能缓存的地址需要速度慢的 PageTables 翻译
# DirectMap1G:    22020096 kB       # 为了尽可能地将地址放进 TLB 缓存，因此 DirectMap 支持了 4K、2M、1G 甚至更大的内存页
```

上述原始信息部分添加了注释，后续在 linux 内核内存管理中将深入研究每一部分的具体信息。

### uptime

**平均负载是指在特定时间间隔内运行队列中的平均进程数。**

**一般情况下，如果每个CPU核当前活动进程数不大于3，那么系统的性能是良好的。**

**如果每个CPU核的任务数大于5，那么这台机器就可能有严重的性能问题。**

即：

如果 linux 主机有1个双核CPU，当 Load Average 为 6 的时候就说明机器已经被充分使用了。

```shell
uptime
# 13:54:47 up 23:25,  2 users,  load average: 0.08, 0.02, 0.01
# 当前时间：13:54:47
# 系统运行时长：23:25
# 当前用户数：2 users
# 平均负载：0.08、0.02、0.01分别为 1min，5min，15min 的均值
# 
w    # 与 uptime 效果基本一致
#  20:14:33 up 1 day,  5:45,  2 users,  load average: 0.00, 0.01, 0.00
# USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
# shiyucun :1       :1               三14   ?xdm?  33:42   0.00s /usr/lib/gdm3/gdm-x-session --run-script env GNOME_SHELL_SESSION_MODE=ubuntu /usr/bin/gnome-session --systemd --s
# shiyucun pts/0    172.25.28.169    19:05    1.00s  0.12s  0.00s w
```

### top

``` shell
top
# top - 19:42:36 up 1 day,  5:13,  2 users,  load average: 0.00, 0.00, 0.00    # 平均负载
# Tasks: 381 total,   1 running, 379 sleeping,   0 stopped,   1 zombie         # task 一共有 381 个，1 个正在运行，379 个休眠，1 个僵尸任务
# %Cpu(s):  0.0 us,  0.0 sy,  0.0 ni, 99.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st  # CPU 使用情况，vmstat 中有详细解释
# MiB Mem :  31826.9 total,  26990.9 free,   1824.0 used,   3012.0 buff/cache      # 内存总体使用情况
# MiB Swap:   2048.0 total,   2048.0 free,      0.0 used.  29547.3 avail Mem       # 交换空间总体使用情况
# 
#     PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
#     927 root      20   0 2380004  47332  25136 S   1.0   0.1   9:06.61 containerd
#     806 avahi     20   0    8988   4324   3552 S   0.3   0.0   3:21.61 avahi-daemon
#   2541 shiyucun  20   0  421328  42216  31560 S   0.3   0.1   4:01.87 sogoupinyinServ
```

### vmstat

```shell
vmstat 2
# procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
# r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
# 0  0      0 27628300 223556 2862684    0    0     1     1   22   11  0  0 100  0  0
# 0  0      0 27628236 223556 2862684    0    0     0     0  256  339  0  0 100  0  0
# 0  0      0 27628236 223556 2862684    0    0     0     0  251  370  0  0 100  0  0
# 0  0      0 27628236 223564 2862684    0    0     0    18  242  351  0  0 100  0  0
# 0  0      0 27628284 223564 2862684    0    0     0     0  240  344  0  0 100  0  0
```

vmstat 是 Virtual Memory Statistics(虚拟内存统计)的缩写，是实时系统监控命令。

该命令通过使用 knlist 子程序和 /dev/kmen 伪设备驱动器访问这些数据。

vmstat 反馈的 CPU 相关的信息包括：

- CPU 有多少任务在运行
- CPU 使用情况
- CPU 收到多少中断
- CPU 发生多少上下文切换

使用方法：`vmstat [delay [count]]`

- delay：指相邻两次采样的间隔时间
- count：指采样的次数

当没有参数时，vmstat 显示系统启动以后所有信息的平均值。

有 delay 参数时：

- 第一行显示自系统启动以来的平均信息
- 第二行开始显示前一个 delay 时间段的平均信息
- 当系统有多个 CPU 时，输出为所有 CPU 的平均值

**如果 r 经常大于4，id 经常少于40，表示 CPU 的负荷很重。**

**如果 bi，bo 长期不等于0，表示内存不足。**

**如果 disk 经常不等于0，且在 b 中的队列大于3，表示 io 性能不好。**

``` text
r: 在 delay 时间段里，运行队列里等待 CPU 的任务的个数(不包含 vmstat 进程)
b: 在 delay 时间段里，被资源阻塞的任务数(I/O、页面调度等)，通常情况下该值应接近 0
swpd: 
free:
buff:
cache:
si: 从交换空间读取到内存的大小
so: 写入交换空间内存的带下
bi: 每秒读取的块数
bo: 每秒写入的块数
in: 在 delay 时间段里，每秒发生中断的次数，公式(intr / delay)
cs: 在 delay 时间段里，每秒发生上下文切换的次数，即每秒内核任务交换的次数，公式(ctxt / delay)
us: 在 delay 时间段里，用户态的 CPU 时间(%)，包含 nice 值为负的进程，公式((user + nice) / total * 100)
sy: 在 delay 时间段里，内核态的 CPU 时间(%)，公式((system + irq + softirq) / total * 100)
id: 在 delay 时间段里，空闲的 CPU 时间(%)，不包括等待 I/O 的时间，公式(idle / total * 100)
wa: 在 delay 时间段里，等待 I/O 的 CPU 时间(%)，公式(iowait / total * 100)
st:
```

### mpstat

mpstat 指令用来显示 cpu 的使用状况，将内容显示到标准输出。

语法：`mpstat [ options ] [ <interval> [ <count> ] ]`

参数 | 含义
--- | ---
-P {cpu l ALL} | 表示监控哪个 CPU， cpu 在 [0,cpu个数-1] 中取值
internal | 相邻的两次采样的间隔时间
count | 采样的次数，count 只能和 delay 一起使用

```shell
mpstat
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 17时02分13秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
# 17时02分13秒  all    0.29    0.06    0.06    0.00    0.00    0.01    0.00    0.00    0.00   99.58
# 
# $ mpstat -P ALL
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 17时02分37秒  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
# 17时02分37秒  all    0.29    0.06    0.06    0.00    0.00    0.01    0.00    0.00    0.00   99.58
# 17时02分37秒    0    0.31    0.06    0.07    0.00    0.00    0.00    0.00    0.00    0.00   99.55
# 17时02分37秒    1    0.31    0.07    0.07    0.01    0.00    0.07    0.00    0.00    0.00   99.48
# 17时02分37秒    2    0.30    0.06    0.07    0.00    0.00    0.00    0.00    0.00    0.00   99.57
# 17时02分37秒    3    0.30    0.06    0.06    0.01    0.00    0.00    0.00    0.00    0.00   99.57
# 17时02分37秒    4    0.29    0.05    0.06    0.01    0.00    0.00    0.00    0.00    0.00   99.60
# 17时02分37秒    5    0.28    0.05    0.06    0.01    0.00    0.00    0.00    0.00    0.00   99.61
# 17时02分37秒    6    0.28    0.06    0.06    0.01    0.00    0.00    0.00    0.00    0.00   99.61
# 17时02分37秒    7    0.27    0.05    0.10    0.00    0.00    0.00    0.00    0.00    0.00   99.57
# 17时02分37秒    8    0.28    0.06    0.05    0.00    0.00    0.00    0.00    0.00    0.00   99.61
# 17时02分37秒    9    0.29    0.06    0.06    0.00    0.00    0.00    0.00    0.00    0.00   99.59
# 17时02分37秒   10    0.28    0.06    0.05    0.00    0.00    0.00    0.00    0.00    0.00   99.60
# 17时02分37秒   11    0.27    0.06    0.05    0.00    0.00    0.03    0.00    0.00    0.00   99.59
# 17时02分37秒   12    0.36    0.05    0.06    0.00    0.00    0.00    0.00    0.00    0.00   99.53
# 17时02分37秒   13    0.30    0.06    0.06    0.01    0.00    0.00    0.00    0.00    0.00   99.58
# 17时02分37秒   14    0.29    0.05    0.05    0.00    0.00    0.00    0.00    0.00    0.00   99.61
# 17时02分37秒   15    0.29    0.05    0.05    0.00    0.00    0.00    0.00    0.00    0.00   99.60
```

参数 | 释义 | 从/proc/stat获得数据
--- | --- | ---
CPU | 处理器ID |
%usr | 在internal时间段里，用户态的CPU时间（%），不包含 nice值为负进程 | usr/total*100
%nice | 在internal时间段里，nice值为负进程的CPU时间（%） | nice/total*100
%sys | 在internal时间段里，核心时间（%） | system/total*100
%iowait | 在internal时间段里，硬盘IO等待时间（%） | iowait/total*100
%irq | 在internal时间段里，硬中断时间（%） | irq/total*100
%soft | 在internal时间段里，软中断时间（%） | softirq/total*100
%steal | 显示虚拟机管理器在服务另一个虚拟处理器时虚拟CPU处在非自愿等待下花费时间的百分比 | steal/total*100
%guest | 显示运行虚拟处理器时CPU花费时间的百分比 | guest/total*100
%gnice |  | gnice/total*100
%idle | 在internal时间段里，CPU除去等待磁盘IO操作外的因为任何原因而空闲的时间闲置时间（%） | idle/total*100

### sar

语法：`sar [ options ] [ <interval> [ <count> ] ]`

options | 说明
--- | ---
-A | 所有报告的总和
-b | 显示I/O和传递速率的统计信息
-B | 显示换页状态
-d | 输出每一块磁盘的使用信息
-e | 设置显示报告的结束时间
-f | 从制定的文件读取报告
-i | 设置状态信息刷新的间隔时间
-P | 报告每个CPU的状态
-R | 显示内存状态
–u | 输出cpu使用情况和统计信息
–v | 显示索引节点、文件和其他内核表的状态
-w | 显示交换分区的状态
-x | 显示给定进程的装
-r | 报告内存利用率的统计信息

```shell
sar -u 1 3  # 每隔 1s 是获取一次 CPU 信息
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 17时28分56秒     CPU     %user     %nice   %system   %iowait    %steal     %idle
# 17时28分57秒     all      0.00      0.00      0.00      0.00      0.00    100.00
# 17时28分58秒     all      0.00      0.00      0.06      0.00      0.00     99.94
# 17时28分59秒     all      0.06      0.00      0.00      0.00      0.00     99.94
# Average:        all      0.02      0.00      0.02      0.00      0.00     99.96
# 
# %user：用户空间的CPU使用
# %nice：改变过优先级的进程的CPU使用率
# %system：内核空间的CPU使用率
# %iowait：CPU等待IO的百分比 
# %steal：虚拟机的虚拟机CPU使用的CPU
# %idle：空闲的CPU
```

在以上的显示当中：

1. **%iowait 和 %idle 过高表示存在 I/O 瓶颈，即磁盘 I/O 无法满足需求**
2. **%idle 过低表示 CPU 使用率高，需要结合内存使用等情况判断 CPU 瓶颈**

查看平均负载：

```shell
sar -q 1 3
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 17时33分41秒   runq-sz  plist-sz   ldavg-1   ldavg-5  ldavg-15   blocked
# 17时33分42秒         0      1042      0.00      0.02      0.00         0
# 17时33分43秒         0      1042      0.00      0.02      0.00         0
# 17时33分44秒         0      1042      0.00      0.02      0.00         0
# Average:            0      1042      0.00      0.02      0.00         0
# 
# runq-sz：运行队列的长度（等待运行的进程数，每核的CP不能超过3个）
# plist-sz：进程列表中的进程（processes）和线程数（threads）的数量
# ldavg-1：最后1分钟的CPU平均负载，即将多核CPU过去一分钟的负载相加再除以核心数得出的平均值，5分钟和15分钟以此类推
# ldavg-5：最后5分钟的CPU平均负载
# ldavg-15：最后15分钟的CPU平均负载
# blocked
```

查看内存使用情况：

```shell
sar -r 1 3
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 17时35分25秒 kbmemfree   kbavail kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit  kbactive   kbinact   kbdirty
# 17时35分26秒   2436332  29329224   2390344      7.33    212176  26613024   8306008     23.95   3608256  25222544         8
# 17时35分27秒   2436332  29329236   2390336      7.33    212184  26613024   8306008     23.95   3608296  25222548        40
# 17时35分28秒   2436332  29329236   2390336      7.33    212184  26613024   8306008     23.95   3608296  25222548        40
# Average:      2436332  29329232   2390339      7.33    212181  26613024   8306008     23.95   3608283  25222547        29
# 
# kbmemfree：空闲的物理内存大小
# kbmemused：使用中的物理内存大小
# %memused：物理内存使用率
# kbbuffers：内核中作为缓冲区使用的物理内存大小，kbbuffers和kbcached:这两个值就是free命令中的buffer和cache
# kbcached：缓存的文件大小
# kbcommit：保证当前系统正常运行所需要的最小内存，即为了确保内存不溢出而需要的最少内存（物理内存+Swap分区）
# commit：这个值是kbcommit与内存总量（物理内存+swap分区）的一个百分比的值
# kbactive
# kbinact
# kbdirty
```

查看 I/O 和传递速率：

```shell
sar -b 1 3
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 17时37分16秒       tps      rtps      wtps      dtps   bread/s   bwrtn/s   bdscd/s
# 17时37分17秒      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时37分18秒      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时37分19秒      2.00      0.00      2.00      0.00      0.00     72.00      0.00
# Average:         0.67      0.00      0.67      0.00      0.00     24.00      0.00
# 
# tps：磁盘每秒钟的IO总数，等于iostat中的tps
# rtps：每秒钟从磁盘读取的IO总数
# wtps：每秒钟从写入到磁盘的IO总数
# bread/s：每秒钟从磁盘读取的块总数
# bwrtn/s：每秒钟此写入到磁盘的块总数
```

查看磁盘使用情况：

```shell
sar -d
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 17时23分45秒  LINUX RESTART     (16 CPU)
# 
# 17时25分01秒       DEV       tps     rkB/s     wkB/s     dkB/s   areq-sz    aqu-sz     await     %util
# 17时35分01秒    dev7-0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒    dev7-1      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒    dev7-2      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒    dev7-3      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒    dev7-4      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒    dev7-5      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒    dev7-6      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒    dev7-7      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒  dev259-0      1.08      0.27      6.51      0.00      6.29      0.00      0.83      0.07
# 17时35分01秒    dev7-8      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒    dev7-9      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒   dev7-10      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒   dev7-11      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒   dev7-12      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒   dev7-13      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒   dev7-14      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒   dev7-15      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒   dev7-16      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒   dev7-17      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒   dev7-18      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒   dev7-19      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时35分01秒   dev7-20      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# Average:       dev7-0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# Average:       dev7-1      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# Average:       dev7-2      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# Average:       dev7-3      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# Average:       dev7-4      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# Average:       dev7-5      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# Average:       dev7-6      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 
# DEV：磁盘设备的名称，如果不加-p，会显示dev253-0类似的设备名称，因此加上-p显示的名称更直接
# tps：每秒 I/O 的传输总数
# rd_sec/s：每秒读取的扇区的总数
# wr_sec/s：每秒写入的扇区的总数
# avgrq-sz：平均每次次磁盘I/O操作的数据大小（扇区）
# avgqu-sz：磁盘请求队列的平均长度
# await：从请求磁盘操作到系统完成处理平均消耗的时间，包括请求队列等待时间，单位是毫秒
# svctm：I/O的服务处理时间，即不包括请求队列中的时间
# %util：I/O请求占用的CPU百分比，值越高，说明I/O越慢
```

sar 还可以用于统计网络相关的信息。

语法：`sar -n { <关键词> [,...] | ALL }`

关键词 | 意义
--- | ---
DEV | 网卡
EDEV | 网卡 (错误)
NFS | NFS 客户端
NFSD | NFS 服务器
SOCK | Sockets (套接字)(v4)
IP | IP 流(v4)
EIP | IP 流(v4) (错误)
ICMP | ICMP 流(v4)
EICMP | ICMP 流(v4) (错误)
TCP | TCP 流(v4)
ETCP | TCP 流(v4) (错误)
UDP | UDP 流(v4)
SOCK6 | Sockets(套接字)    (v6)
IP6 | IP 流(v6)
EIP6 | IP 流(v6) (错误)
ICMP6 | ICMP 流(v6)
EICMP6 | ICMP 流(v6) (错误)
UDP6 | UDP 流(v6)

网络接口信息：

```shell
sar -n DEV 1 1
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 17时43分01秒     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
# 17时43分02秒        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时43分02秒      eno1    146.00      3.00     34.35      0.38      0.00      0.00    142.00      0.03
# 17时43分02秒   docker0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 
# Average:        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
# Average:           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# Average:         eno1    146.00      3.00     34.35      0.38      0.00      0.00    142.00      0.03
# Average:      docker0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 
# IFACE：本地网卡接口的名称
# rxpck/s：每秒钟接受的数据包
# txpck/s：每秒钟发送的数据库
# rxKB/S：每秒钟接受的数据包大小，单位为KB
# txKB/S：每秒钟发送的数据包大小，单位为KB
# rxcmp/s：每秒钟接受的压缩数据包
# txcmp/s：每秒钟发送的压缩包
# rxmcst/s：每秒钟接收的多播数据包

sar -n EDEV 1 1
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 17时52分04秒     IFACE   rxerr/s   txerr/s    coll/s  rxdrop/s  txdrop/s  txcarr/s  rxfram/s  rxfifo/s  txfifo/s
# 17时52分05秒        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时52分05秒      eno1      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 17时52分05秒   docker0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 
# Average:        IFACE   rxerr/s   txerr/s    coll/s  rxdrop/s  txdrop/s  txcarr/s  rxfram/s  rxfifo/s  txfifo/s
# Average:           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# Average:         eno1      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# Average:      docker0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
# 
# IFACE：网卡名称
# rxerr/s：每秒钟接收到的损坏的数据包
# txerr/s：每秒钟发送的数据包错误数
# coll/s：当发送数据包时候，每秒钟发生的冲撞（collisions）数，这个是在半双工模式下才有
# rxdrop/s：当由于缓冲区满的时候，网卡设备接收端每秒钟丢掉的网络包的数目
# txdrop/s：当由于缓冲区满的时候，网络设备发送端每秒钟丢掉的网络包的数目
# txcarr/s：当发送数据包的时候，每秒钟载波错误发生的次数
# rxfram/s：在接收数据包的时候，每秒钟发生的帧对其错误的次数
# rxfifo/s：在接收数据包的时候，每秒钟缓冲区溢出的错误发生的次数
# txfifo/s：在发生数据包的时候，每秒钟缓冲区溢出的错误发生的次数
```

查看 socket 连接信息：

```shell
sar -n SOCK 1 1
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 17时54分00秒    totsck    tcpsck    udpsck    rawsck   ip-frag    tcp-tw
# 17时54分01秒      1289        22        18         0         6         0
# Average:         1289        22        18         0         6         0
# 
# totsck：当前被使用的socket总数
# tcpsck：当前正在被使用的TCP的socket总数
# udpsck：当前正在被使用的UDP的socket总数
# rawsck：当前正在被使用于RAW的skcket总数
# if-frag：当前的IP分片的数目
# tcp-tw：TCP套接字中处于TIME-WAIT状态的连接数量
```

查看 TCP 连接信息：

```shell
sar -n TCP 1 1
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 17时55分36秒  active/s passive/s    iseg/s    oseg/s
# 17时55分37秒      0.00      0.00      1.00      1.00
# Average:         0.00      0.00      1.00      1.00
# 
# active/s：新的主动连接
# passive/s：新的被动连接
# iseg/s：接受的段
# oseg/s：输出的段
```

### /proc/stat

**/proc/stat** 节点记录的是系统进程整体的统计信息，是从开机到当前时间积累的所有cpu时间。

```shell
cat /proc/stat
# CPU 指标：user，nice, system, idle, iowait, irq, softirq
# cpu  3348367 642069 702597 1140973291 55534 0 71841 0 0 0
# cpu0 220996 44687 53285 71270026 3313 0 140 0 0 0
# cpu1 220355 47840 51250 71227693 3600 0 46927 0 0 0
# cpu2 216562 41908 46571 71313169 3484 0 93 0 0 0
# cpu3 215990 40690 45008 71318419 4118 0 73 0 0 0
# cpu4 204309 37432 40573 71339083 3642 0 89 0 0 0
# cpu5 200361 36796 39700 71343963 3950 0 82 0 0 0
# cpu6 197815 39846 40204 71345174 3617 0 78 0 0 0
# cpu7 192580 35759 72002 71265045 3161 0 104 0 0 0
# cpu8 198554 42623 36824 71350822 3139 0 85 0 0 0
# cpu9 204070 43730 39773 71341109 3035 0 80 0 0 0
# cpu10 202392 41029 38954 71348513 2968 0 83 0 0 0
# cpu11 190737 39254 39018 71205989 2966 0 23548 0 0 0
# cpu12 254695 37550 43268 71285938 2378 0 130 0 0 0
# cpu13 214126 40808 40456 71325991 6648 0 104 0 0 0
# cpu14 204911 35919 37560 71350867 2569 0 106 0 0 0
# cpu15 209908 36193 38145 71341483 2938 0 114 0 0 0
# intr 327016225 7 0 0 0 0 0 0 0 1 6 0 0 0 0 0 0 6 845 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 57 4602 89646857 0 156409 170522 164553 176008 135694 147550 156008 128689 137676 160414 152415 146188 122936 161752 117539 139893 342 10125 1687 4983682 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
# ctxt 639900304
# btime 1646016839
# processes 791802
# procs_running 1
# procs_blocked 0
# softirq 392714522 4524 108377654 157793 92744737 7678 0 10072 102521374 201298 88689392
# intr：系统启动以来的所有interrupts的次数情况
# ctxt: 系统上下文切换次数
# btime：启动时长(单位:秒)，从Epoch(即1970零时)开始到系统启动所经过的时长，每次启动会改变
# processes：系统启动后所创建过的进程数量，当短时间该值特别大，系统可能出现异常
# procs_running：处于 Runnable 状态的进程个数
# procs_blocked：处于等待 I/O 完成的进程个数
```

### ps

```shell
ps -aux
# USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
# root           1  0.0  0.0 168168  9948 ?        Ss   2月28   0:11 /sbin/init splash
# root           2  0.0  0.0      0     0 ?        S    2月28   0:00 [kthreadd]
# root           3  0.0  0.0      0     0 ?        I<   2月28   0:00 [rcu_gp]
# root           4  0.0  0.0      0     0 ?        I<   2月28   0:00 [rcu_par_gp]
# root           6  0.0  0.0      0     0 ?        I<   2月28   0:00 [kworker/0:0H-kblockd]
# root           9  0.0  0.0      0     0 ?        I<   2月28   0:00 [mm_percpu_wq]
# root          10  0.0  0.0      0     0 ?        S    2月28   0:01 [ksoftirqd/0]
# root          11  0.1  0.0      0     0 ?        I    2月28  13:46 [rcu_sched] 

# USER：启动进程的用户
# PID：进程pid
# %CPU：进程CPU使用率
# %MEM：进程的内存使用率
# VSZ：占用虚拟内存大小
# RSS：占用物理内存大小
# TTY：登入者的终端机位置
# STAT：进程状态
# START：进程开始时间
# TIME：执行的时间
# COMMAND：所执行的指令
```

### pidstat

pidstat 是 sysstat 工具的一个命令。

用于监控全部或指定进程的cpu、内存、线程、设备IO等系统资源的占用情况。

pidstat 首次运行时显示自系统启动开始的各项统计信息。

首次运行之后运行 pidstat 将显示自上次运行该命令以后的统计信息。

用户可以通过指定统计的次数和时间来获得所需的统计信息。

语法：`pidstat [ 选项 ] [ <时间间隔> ] [ <次数> ]`

```shell
pidstat    # CPU 使用情况统计，和加上 -u 选项效果一致
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 18时42分56秒   UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
# 18时42分56秒     0         1    0.00    0.00    0.00    0.00    0.00     7  systemd
# 18时42分56秒     0         2    0.00    0.00    0.00    0.00    0.00     2  kthreadd
# 18时42分56秒     0        10    0.00    0.00    0.00    0.00    0.00     0  ksoftirqd/0
# 18时42分56秒     0        11    0.07    0.05    0.00    0.02    0.11    14  rcu_sched
# 18时42分56秒     0        12    0.00    0.00    0.00    0.00    0.00     0  migration/0
# 18时42分56秒     0        17    0.00    0.00    0.00    0.00    0.00     1  migration/1
# 18时42分56秒     0        18    0.00    0.00    0.00    0.00    0.00     1  ksoftirqd/1
# 18时42分56秒     0        23    0.00    0.00    0.00    0.00    0.00     2  migration/2
# 18时42分56秒     0        24    0.00    0.00    0.00    0.00    0.00     2  ksoftirqd/2
# 18时42分56秒     0        29    0.00    0.00    0.00    0.00    0.00     3  migration/3
# 18时42分56秒     0        30    0.00    0.00    0.00    0.00    0.00     3  ksoftirqd/3
# 18时42分56秒     0        35    0.00    0.00    0.00    0.00    0.00     4  migration/4
# 18时42分56秒     0        36    0.00    0.00    0.00    0.00    0.00     4  ksoftirqd/4
# 18时42分56秒     0        41    0.00    0.00    0.00    0.00    0.00     5  migration/5
# 18时42分56秒     0        42    0.00    0.00    0.00    0.00    0.00     5  ksoftirqd/5
# 18时42分56秒     0        47    0.00    0.00    0.00    0.00    0.00     6  migration/6 
# 
# PID：进程ID
# %usr：进程在用户空间占用cpu的百分比
# %system：进程在内核空间占用cpu的百分比
# %guest：进程在虚拟机占用cpu的百分比
# %CPU：进程占用cpu的百分比
# CPU：处理进程的cpu编号
# Command：当前进程对应的命令

pidstat -r    # 内存使用情况统计
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 18时46分57秒   UID       PID  minflt/s  majflt/s     VSZ     RSS   %MEM  Command
# 18时46分57秒     0         1      0.27      0.00  168168    9948   0.03  systemd
# 18时46分57秒     0       373      0.34      0.00  201932   71096   0.22  systemd-journal
# 18时46分57秒     0       402      0.01      0.00   24056    6284   0.02  systemd-udevd
# 18时46分57秒   101       770      0.00      0.00   24364   10384   0.03  systemd-resolve
# 18时46分57秒   102       771      0.00      0.00   90456    4620   0.01  systemd-timesyn
# 18时46分57秒     0       815      0.00      0.00  247488    6976   0.02  accounts-daemon
# 18时46分57秒     0       816      0.00      0.00    2548     780   0.00  acpid
# 18时46分57秒   115       819      0.00      0.00    9280    4472   0.01  avahi-daemon
# 18时46分57秒     0       820      0.03      0.00   18052    2944   0.01  cron
# 18时46分57秒   103       823      0.00      0.00   10148    6564   0.02  dbus-daemon
# 18时46分57秒     0       825      0.00      0.00  492300   15928   0.05  NetworkManager
# 18时46分57秒     0       834      0.00      0.00   81948    3372   0.01  irqbalance 
# 
# PID：进程ID
# Minflt/s：任务每秒发生的次要错误，不需要从磁盘中加载页
# Majflt/s：任务每秒发生的主要错误，需要从磁盘中加载页
# VSZ：虚拟地址大小，虚拟内存的使用KB
# RSS：常驻集合大小，非交换区五里内存使用KB
# Command：task命令名

pidstat -d    # I/O 情况统计
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 18时49分36秒   UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command
# 18时49分36秒     0         1     -1.00     -1.00     -1.00 19621004  systemd
# 18时49分36秒     0       333     -1.00     -1.00     -1.00   15662  jbd2/nvme0n1p2-
# 18时49分36秒     0       373     -1.00     -1.00     -1.00     313  systemd-journal
# 18时49分36秒     0       402     -1.00     -1.00     -1.00       1  systemd-udevd
# 18时49分36秒     0       476     -1.00     -1.00     -1.00       2  loop2
# 18时49分36秒     0       576     -1.00     -1.00     -1.00       1  loop6
# 18时49分36秒     0       694     -1.00     -1.00     -1.00       3  loop10
# 18时49分36秒     0       699     -1.00     -1.00     -1.00       6  loop11
# 18时49分36秒     0       720     -1.00     -1.00     -1.00       8  loop14
# 18时49分36秒     0       737     -1.00     -1.00     -1.00       3  loop18
# 18时49分36秒   101       770     -1.00     -1.00     -1.00       1  systemd-resolve
# 18时49分36秒   103       823     -1.00     -1.00     -1.00       2  dbus-daemon
# 18时49分36秒     0       825     -1.00     -1.00     -1.00     356  NetworkManager
# 18时49分36秒     0       836     -1.00     -1.00     -1.00       3  lttng-sessiond
# 18时49分36秒     0       839     -1.00     -1.00     -1.00       8  networkd-dispat
# 
# PID：进程ID
# kB_rd/s：每秒从磁盘读取的KB
# kB_wr/s：每秒写入磁盘KB
# kB_ccwr/s：任务取消的写入磁盘的KB。当任务截断脏的pagecache的时候会发生。
# COMMAND：task的命令名

pidstat -w    # 上下文切换情况统计
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 18时51分25秒   UID       PID   cswch/s nvcswch/s  Command
# 18时51分25秒     0         1      0.11      0.00  systemd
# 18时51分25秒     0         2      0.00      0.00  kthreadd
# 18时51分25秒     0         3      0.00      0.00  rcu_gp
# 18时51分25秒     0         4      0.00      0.00  rcu_par_gp
# 18时51分25秒     0         6      0.00      0.00  kworker/0:0H-kblockd
# 18时51分25秒     0         9      0.00      0.00  mm_percpu_wq
# 18时51分25秒     0        10      0.09      0.00  ksoftirqd/0
# 18时51分25秒     0        11     40.25      0.00  rcu_sched
# 18时51分25秒     0        12      0.25      0.00  migration/0 
# 
# PID：进程ID
# Cswch/s：每秒主动任务上下文切换数量
# Nvcswch/s：每秒被动任务上下文切换数量
# Command：命令名

pidstat -t    # 线程相关的统计信息
# Linux 5.8.0-43-generic (shiyucun)       2022年03月08日  _x86_64_        (16 CPU)
# 
# 18时52分56秒   UID      TGID       TID    %usr %system  %guest   %wait    %CPU   CPU  Command
# 18时52分56秒     0         1         -    0.00    0.00    0.00    0.00    0.00     7  systemd
# 18时52分56秒     0         -         1    0.00    0.00    0.00    0.00    0.00     7  |__systemd
# 18时52分56秒     0         2         -    0.00    0.00    0.00    0.00    0.00     2  kthreadd
# 18时52分56秒     0         -         2    0.00    0.00    0.00    0.00    0.00     2  |__kthreadd
# 18时52分56秒     0        10         -    0.00    0.00    0.00    0.00    0.00     0  ksoftirqd/0
# 18时52分56秒     0         -        10    0.00    0.00    0.00    0.00    0.00     0  |__ksoftirqd/0
# 18时52分56秒     0        11         -    0.07    0.05    0.00    0.02    0.11     1  rcu_sched
# 18时52分56秒     0         -        11    0.00    0.11    0.00    0.02    0.11     1  |__rcu_sched
# 18时52分56秒     0        12         -    0.00    0.00    0.00    0.00    0.00     0  migration/0
# 18时52分56秒     0         -        12    0.00    0.00    0.00    0.00    0.00     0  |__migration/0
# 18时52分56秒     0        17         -    0.00    0.00    0.00    0.00    0.00     1  migration/1 
# 
# TGID：主线程
# TID：线程id
# %usr：进程在用户空间占用cpu的百分比
# %system：进程在内核空间占用cpu的百分比
# %guest：进程在虚拟机占用cpu的百分比
# %CPU：进程占用cpu的百分比
# CPU：处理进程的cpu编号
# Command：当前进程对应的命令
```

### htop

htop 类似于 top 命令，但可以在垂直和水平方向上滚动。

可以看到系统上所有运行的进程，以及完整的运行命令。

可以不输入进程的PID就可以对此进程进行相关的操作。

htop 是 linux 系统中的一个互动的进程查看器。

与 linux 传统的 top 相比，htop 更加人性化。

它可以让用户交互式操作，支持颜色主题，可横向或者纵向滚动浏览进程列表，并支持鼠标操作。

### atop

atop 是一个功能强大的 linux 服务器监控工具。

atop 支持收集和显示 CPU、内存、磁盘、网络，进程等资源的相关信息。

负载比较大的资源信息会以特别的颜色显示，可以作为系统管理的辅助工具使用。

### /proc/softirqs

记录自开机以来软中断累积次数。

```shell
cat /proc/softirqs
#                     CPU0       CPU1       CPU2       CPU3       CPU4       CPU5       CPU6       CPU7       CPU8       CPU9       CPU10      CPU11      CPU12      CPU13      CPU14      CPU15
#           HI:          0          1         30          0          0          0          0          0          0         42       4448          1          2          0          0          0
#        TIMER:   11673191   11006078    7174958    6614400    5898820    6141112    5832033    5732579    5141742    5232003    5297361    9729754    6785323    5918640    5259153    5465226
#       NET_TX:      72394      10955        430        398        301        424        397        186        577        363        571      69420        656        530        528        450
#       NET_RX:     214562   57604667     179738     186497     192551     177763     176093     175043     170186     170049     183440   32513376     223893     196680     205056     209847
#        BLOCK:       3613        408        489        407        717        135        114        198         64        240        187         34        189        242        391        251
#     IRQ_POLL:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0
#      TASKLET:         74       1716          1          0          1          0          0          0          0         89         10       8406         69          0          0          0
#        SCHED:   11484831   10662592    6823147    6223777    5543777    5797156    5462191    5373193    4787185    4842055    4929448    9350759    6297766    5518347    4884192    5061156
#      HRTIMER:          7     158341         12         10         14         16         19         10         11         10         12      42791         12         10         17          6
#          RCU:    9570774    8762199    5937102    5398145    4824847    4969803    4746644    4679830    4138521    4169891    4282744    8336261    5773704    4793612    4299410    4469099
#         
# TIMER（定时中断）、NET_RX（网络接收）、SCHED（内核调度）、RCU（RCU 锁）
```

### /proc/interrupts

```shell
cat /proc/interrupts
#              CPU0       CPU1       CPU2       CPU3       CPU4       CPU5       CPU6       CPU7       CPU8       CPU9       CPU10      CPU11      CPU12      CPU13      CPU14      CPU15
#  144:          0          0          0          0          0          0          0          0          0          0          0          0          0          0     117749         0  IR-PCI-MSI 1048591-edge      nvme0q15
#  145:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0     139979  IR-PCI-MSI 1048592-edge      nvme0q16
#  146:          0        358          0          0          0          0          0          0          0          0          0          0          0          0          0         0  IR-PCI-MSI 360448-edge      mei_me
#  147:          0          0        282          0          0          0          0          0          0      10323          0          0          0          0          0         0  IR-PCI-MSI 32768-edge      i915
#  148:          0          0          0          0       1687          0          0          0          0          0          0          0          0          0          0         0  IR-PCI-MSI 514048-edge      snd_hda_intel:card0
#  149:          0        380          0      67263          0       1404          0    4918503          0         60          0        110          0          0          0       150  IR-PCI-MSI 524288-edge      nvidia
#  NMI:        411        490        391        390        367        356        361        385        355        369        363        416        442        380        358       367   Non-maskable interrupts
#  LOC:   19226902   18122668   13685423   12984663   12538972   12545999   11945371   12225225   10962287   11416510   11246447   15657688   13019961   12150303   11110649   11654252   Local timer interrupts
#  SPU:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0         0   Spurious interrupts
#  PMI:        411        490        391        390        367        356        361        385        355        369        363        416        442        380        358       367   Performance monitoring interrupts
#  IWI:          0          0         14          0          0          0          0          0          0          0          0          2          0          0          0         0   IRQ work interrupts
#  RTR:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0         0   APIC ICR read retries
#  RES:     173756     296835     189336     190963     200006     190280     183948     151660     174497     183486     177326     220583     179442     184993     182363     164066   Rescheduling interrupts
#  CAL:    1202989    1097490    1022167    1001855    1119133    1254341    1163177    1103111    1069154    1073957    1179340     889649    1026010    1102822    1175895    1044907   Function call interrupts
#  TLB:     812209    1018864     801455     933607    1027931    1262438    1024829    1067710     989737     984651    1150732     857788     875536     962798    1050856    1053165   TLB shootdowns
#  TRM:        596        596        596        596        596        596        596        596        596        596        596        596        596        596        596       596   Thermal event interrupts
#  THR:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0         0   Threshold APIC interrupts
#  DFR:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0         0   Deferred Error APIC interrupts
#  MCE:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0         0   Machine check exceptions
#  MCP:       2316       2317       2317       2317       2317       2317       2317       2317       2317       2317       2317       2317       2317       2317       2317       2317   Machine check polls
#  ERR:          0
#  MIS:          0
#  PIN:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0         0   Posted-interrupt notification event
#  NPI:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0         0   Nested posted-interrupt event
#  PIW:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0         0   Posted-interrupt wakeup event
 
# 字段依次是逻辑中断号、中断在各CPU上发生的次数，中断所属父设备名称、硬件中断号、中断触发方式(电平或边沿)、中断名称
```

### dstat

```shell
dstat
# You did not select any stats, using -cdngy by default.
# --total-cpu-usage-- -dsk/total- -net/total- ---paging-- ---system--
# usr sys idl wai stl| read  writ| recv  send|  in   out | int   csw
#   0   0 100   0   0| 354k 1020k|   0     0 | 168B  646B| 455   890
#   0   0 100   0   0|   0     0 |1849B  810B|   0     0 | 260   429
#   0   0 100   0   0|   0     0 | 198B  346B|   0     0 | 434   789
#   0   0 100   0   0|   0   288k| 615B  346B|   0     0 | 247   428
#   0   0 100   0   0|   0     0 | 348B  354B|   0     0 | 239   421
#   0   0 100   0   0|   0     0 | 615B  346B|   0     0 | 252   413
```

### /proc/cpuinfo

```shell
cat /proc/cpuinfo
# processor       : 0
# vendor_id       : GenuineIntel
# cpu family      : 6
# model           : 165
# model name      : Intel(R) Core(TM) i7-10700 CPU @ 2.90GHz
# stepping        : 5
# microcode       : 0xec
# cpu MHz         : 800.099
# cache size      : 16384 KB
# physical id     : 0
# siblings        : 16
# core id         : 0
# cpu cores       : 8
# apicid          : 0
# initial apicid  : 0
# fpu             : yes
# fpu_exception   : yes
# cpuid level     : 22
# wp              : yes
# flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc art arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 sdbg fma cx16 xtpr pdcm pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch cpuid_fault epb invpcid_single ssbd ibrs ibpb stibp ibrs_enhanced tpr_shadow vnmi flexpriority ept vpid ept_ad fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid mpx rdseed adx smap clflushopt intel_pt xsaveopt xsavec xgetbv1 xsaves dtherm ida arat pln pts hwp hwp_notify hwp_act_window hwp_epp pku ospke md_clear flush_l1d arch_capabilities
# vmx flags       : vnmi preemption_timer posted_intr invvpid ept_x_only ept_ad ept_1gb flexpriority apicv tsc_offset vtpr mtf vapic ept vpid unrestricted_guest vapic_reg vid ple shadow_vmcs pml ept_mode_based_exec
# bugs            : spectre_v1 spectre_v2 spec_store_bypass swapgs itlb_multihit
# bogomips        : 5799.77
# clflush size    : 64
# cache_alignment : 64
# address sizes   : 39 bits physical, 48 bits virtual
# power management: 

# processor：系统中逻辑处理核的编号，对于单核处理器，则是其CPU编号，对于多核处理器则是物理核、或者使用超线程技术虚拟的逻辑核
# vendor_id：CPU制造商
# cpu family：CPU产品系列代号
# model：CPU属于其系列中的哪一代的代号
# model name：CPU属于的名字及其编号、标称主频
# stepping：CPU属于制作更新版本
# cpu MHz：CPU的实际使用主频
# cache size：CPU二级缓存大小
# physical id：单个CPU的标号
# siblings：单个CPU逻辑物理核数
# core id：当前物理核在其所处CPU中的编号，这个编号不一定连续
# cpu cores：该逻辑核所处CPU的物理核数
# apicid：用来区分不同逻辑核的编号，系统中每个逻辑核的此编号必然不同，此编号不一定连续
# fpu：是否具有浮点运算单元（Floating Point Unit）
# fpu_exception：是否支持浮点计算异常
# cpuid level：执行cpuid指令前，eax寄存器中的值，根据不同的值cpuid指令会返回不同的内容
# wp：表明当前CPU是否在内核态支持对用户空间的写保护（Write Protection）
# flags：当前CPU支持的功能
# bogomips：在系统内核启动时粗略测算的CPU速度（Million Instructions Per Second）
# clflush size：每次刷新缓存的大小单位
# cache_alignment：缓存地址对齐单位
# address sizes：可访问地址空间位数
# power management：对能源管理的支持
```

### lscpu

显示 CPU 架构相关的信息。

```shell
lscpu
# Architecture:                    x86_64
# CPU op-mode(s):                  32-bit, 64-bit
# Byte Order:                      Little Endian
# Address sizes:                   39 bits physical, 48 bits virtual
# CPU(s):                          16
# On-line CPU(s) list:             0-15
# Thread(s) per core:              2
# Core(s) per socket:              8
# Socket(s):                       1
# NUMA node(s):                    1
# Vendor ID:                       GenuineIntel
# CPU family:                      6
# Model:                           165
# Model name:                      Intel(R) Core(TM) i7-10700 CPU @ 2.90GHz
# Stepping:                        5
# CPU MHz:                         800.431
# CPU max MHz:                     4800.0000
# CPU min MHz:                     800.0000
# BogoMIPS:                        5799.77
# Virtualization:                  VT-x
# L1d cache:                       256 KiB
# L1i cache:                       256 KiB
# L2 cache:                        2 MiB
# L3 cache:                        16 MiB
# NUMA node0 CPU(s):               0-15
# Vulnerability Itlb multihit:     KVM: Mitigation: VMX disabled
# Vulnerability L1tf:              Not affected
# Vulnerability Mds:               Not affected
# Vulnerability Meltdown:          Not affected
# Vulnerability Spec store bypass: Mitigation; Speculative Store Bypass disabled via prctl and seccomp
# Vulnerability Spectre v1:        Mitigation; usercopy/swapgs barriers and __user pointer sanitization
# Vulnerability Spectre v2:        Mitigation; Enhanced IBRS, IBPB conditional, RSB filling
# Vulnerability Srbds:             Not affected
# Vulnerability Tsx async abort:   Not affected
# Flags:                           fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp
#                                   lm constant_tsc art arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq dtes64 monitor ds_cpl vmx smx est t
#                                 m2 ssse3 sdbg fma cx16 xtpr pdcm pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch cp
#                                 uid_fault epb invpcid_single ssbd ibrs ibpb stibp ibrs_enhanced tpr_shadow vnmi flexpriority ept vpid ept_ad fsgsbase tsc_adjust bmi1 avx2 smep b
#                                 mi2 erms invpcid mpx rdseed adx smap clflushopt intel_pt xsaveopt xsavec xgetbv1 xsaves dtherm ida arat pln pts hwp hwp_notify hwp_act_window hwp
#                                 _epp pku ospke md_clear flush_l1d arch_capabilities
```

### perf

```shell
perf --help    # 查看 perf 的二级命令

# usage: perf [--version] [--help] [OPTIONS] COMMAND [ARGS]
# 
# The most commonly used perf commands are:
#   annotate        Read perf.data (created by perf record) and display annotated code
#   archive         Create archive with object files with build-ids found in perf.data file
#   bench           General framework for benchmark suites
#   buildid-cache   Manage build-id cache.
#   buildid-list    List the buildids in a perf.data file
#   c2c             Shared Data C2C/HITM Analyzer.
#   config          Get and set variables in a configuration file.
#   data            Data file related processing
#   diff            Read perf.data files and display the differential profile
#   evlist          List the event names in a perf.data file
#   ftrace          simple wrapper for kernel's ftrace functionality
#   inject          Filter to augment the events stream with additional information
#   kallsyms        Searches running kernel for symbols
#   kmem            Tool to trace/measure kernel memory properties
#   kvm             Tool to trace/measure kvm guest os
#   list            List all symbolic event types
#   lock            Analyze lock events
#   mem             Profile memory accesses
#   record          Run a command and record its profile into perf.data
#   report          Read perf.data (created by perf record) and display the profile
#   sched           Tool to trace/measure scheduler properties (latencies)
#   script          Read perf.data (created by perf record) and display trace output
#   stat            Run a command and gather performance counter statistics
#   test            Runs sanity tests.
#   timechart       Tool to visualize total system behavior during a workload
#   top             System profiling tool.
#   version         display the version of perf binary
#   probe           Define new dynamic tracepoints
#   trace           strace inspired tool
# 
# See 'perf help COMMAND' for more information on a specific command.
```

全局性概况：

```shell
perf list   # 查看当前系统支持的性能事件；
perf bench  # 对系统性能进行摸底；
perf test   # 对系统进行健全性测试；
perf stat   # 对全局性能进行统计；
```

全局细节：

```shell
perf top    # 可以实时查看当前系统进程函数占用率情况；
perf probe  # 可以自定义动态事件；
```

特定功能分析：

```shell
perf kmem   # 针对slab子系统性能分析；
perf kvm    # 针对kvm虚拟化分析；
perf lock   # 分析锁性能；
perf mem    # 分析内存slab性能；
perf sched  # 分析内核调度器性能；
perf trace  # 记录系统调用轨迹；
```

最常用功能 **perf record**：

- 可以系统全局，也可以具体到某个进程。
- 甚至具体到某一进程某一事件，可宏观，也可以很微观

```shell
pref record    # 记录信息到perf.data；
perf report    # 生成报告；
perf diff      # 对两个记录进行diff；
perf evlist    # 列出记录的性能事件；
perf annotate  # 显示perf.data函数代码；
perf archive   # 将相关符号打包，方便在其它机器进行分析；
perf script    # 将perf.data输出可读性文本；
```

可视化工具perf timechart：

```shell
perf timechart record  # 记录事件；
perf timechart         # 生成output.svg文档
```

### execsnoop

linux中创建进程的开销是比较大的：

- 进程之间地址空间不共享，资源也不共享，都需要copy一份
- 线程之间是共享地址空间，线程间调度的时候地址空间是一样的 tlb cache 往往不会大量失效

有时 top 看到的 CPU 使用率已经到了100%，但各个进程的cpu使用率相加只有30%。

这种远低于100%的情况是因为系统快速创建的进程往往没有被显示出来，(top 更新频率 1次/s)。

execsnoop可以查看短时进程。

工具地址：`https://gitee.com/rtoax/perf-tools`

### proc/pid/stat

```shell
cat /proc/1321/stat
# 1321 (gsd-housekeepin) S 1201 1038 1038 1025 1038 4194304 762        # 1~10
# 0 1 0 2706 787 0 0 20 0 4 0 929 403509248 1653 18446744073709551615  # 11 ~ 25
# 1 1 0 0 0 0 0 4096 16384 0 0 0 17 8 0 0 0 0 0 00 0 0 0 0 0 0

# 1 pid： 进程ID.
# 2 comm: task_struct结构体的进程名
# 3 state: 进程状态, 此处为S
# 4 ppid: 父进程ID （父进程是指通过fork方式，通过clone并非父进程）
# 5 pgrp：进程组ID
# 6 session：进程会话组ID
# 7 tty_nr：当前进程的tty终点设备号
# 8 tpgid：控制进程终端的前台进程号
# 9 flags：进程标识位，定义在include/linux/sched.h中的PF_*, 此处等于4194304
# 10 minflt： 次要缺页中断的次数，即无需从磁盘加载内存页. 比如COW和匿名页
# 11 cminflt：当前进程等待子进程的minflt
# 12 majflt：主要缺页中断的次数，需要从磁盘加载内存页. 比如map文件
# 13 majflt：当前进程等待子进程的majflt
# 14 utime: 该进程处于用户态的时间，单位jiffies，此处等于2706
# 15 stime: 该进程处于内核态的时间，单位jiffies，此处等于787
# 16 cutime：当前进程等待子进程的utime
# 17 cstime: 当前进程等待子进程的stime
# 18 priority: 进程优先级, 此次等于10.
# 19 nice: nice值，取值范围[19, -20]，此处等于0
# 20 num_threads: 线程个数, 此处等于4
# 21 itrealvalue: 该字段已废弃，恒等于0
# 22 starttime：自系统启动后的进程创建时间，单位jiffies，此处等于929
# 23 vsize：进程的虚拟内存大小，单位为bytes
# 24 rss: 进程独占内存+共享库，单位pages，此处等于1653
# 25 rsslim: rss大小上限
```
